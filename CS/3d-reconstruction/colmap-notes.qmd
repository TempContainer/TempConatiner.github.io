---
title: "colmap 源码阅读"
order: 1
date: 2024-3-28
date-modified: last-modified
description: "特征提取、匹配与增量 SfM。"
---

## 前置准备

### 基本流程

首先，建立工作文件夹，在工作文件夹中新建一个 images 文件夹来存图片。当然也可以把图片放在另一个目录。

重建命令：

``` bash
colmap automatic_reconstructor --workspace_path 3dwk --image_path 3dwk/images
```

会生成稀疏点云、稠密点云和泊松重建的三维网格体，同时还有存有图片特征点的数据库。

### 代码流

``` bash
colmap.cc -> sfm.cc -> automatic_reconstruction.cc -> feature_extraction.cc -> feature_matching.cc -> incremental_mapper.cc
```

`camera_model` 默认为 `SIMPLE_RADIAL`。重建质量默认为 `HIGH`。特征匹配的默认匹配器为 `ExhaustiveFeatureMatcher`。

## 模块分析

### 特征提取

相关文件位于 `src\colmap\controllers\feature_extraction.cc`。分为两种：extractor 和 importer。

``` cpp
// Reads images from a folder, extracts features, and writes them to database.
std::unique_ptr<Thread> CreateFeatureExtractorController(
    const ImageReaderOptions& reader_options,
    const SiftExtractionOptions& sift_options);

// Import features from text files. Each image must have a corresponding text
// file with the same name and an additional ".txt" suffix.
std::unique_ptr<Thread> CreateFeatureImporterController(
    const ImageReaderOptions& reader_options, const std::string& import_path);
```